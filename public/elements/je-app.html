<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-icons/core-icons.html">
<link rel="import"
      href="../bower_components/core-scaffold/core-scaffold.html">
<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/core-menu/core-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import"
      href="../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import"
      href="../bower_components/core-animated-pages/transitions/slide-from-right.html">
<link rel="import" href="../bower_components/app-router/app-router.html">
<link rel="import" href="../elements/je-session.html">
<link rel="import" href="../elements/je-login.html">
<link rel="import" href="../elements/je-exercises.html">
<link rel="import" href="../elements/je-submit-exercise.html">
<link rel="import" href="../elements/je-exercise-management.html">

<polymer-element name="je-app">
  <template>
    <style>
      .page {
        overflow: scroll;
      }
      .page {
        padding: 1em 3em;
        background-color: white;
      }
      core-menu {
        color: #01579b;
        margin: 10px 0 0 0;
      }
      core-menu > paper-item {
        transition: all 300ms ease-in-out;
      }
      paper-item a {
        text-decoration: none;
        margin-left: 5px;
      }
      core-menu > paper-item.core-selected {
        background: #e1f5fe;
      }
      @media all and (max-width: 480px) {
        core-animated-pages {
          width: 100%;
          height: 100%;
        }
      }
    </style>

    <je-session session="{{session}}"></je-session>

    <core-scaffold>
      <nav>
        <core-toolbar><span>Javascript Examiner</span></core-toolbar>
        <core-menu selected="{{route}">
          <template repeat="{{page in pages}}">
            <paper-item noink>
              <core-icon icon="label-outline"></core-icon>
              <a href="#/{{page.hash}}">{{page.name}}</a>
            </paper-item>
          </template>
        </core-menu>
      </nav>

      <core-toolbar tool flex>
        <div flex>Application</div>
      </core-toolbar>

      <div class="page" horizontal center-center fit>
        <app-router id="router" mode="hash"
            on-state-change="{{onStateChangeAppRouter}}">
          <app-route path="/forbidden">
            <template>
              <h1>Forbidden</h1>
              <p>You are not allowed to enter this page. Please go back.</p>
            </template>
          </app-route>
          <app-route path="/exercises" element="je-exercises"
                     on-before-data-binding="{{onBeforeDataBindingLoginRoute}}"></app-route>
          <app-route path="/exercises/:exerciseId"
                     element="je-submit-exercise"></app-route>
          <app-route path="/login" element="je-login" bindRouter
                     on-before-data-binding="{{onBeforeDataBindingLoginRoute}}"></app-route>
          <app-route path="/exercises/:exerciseId/edit"
                     element="je-exercise-management" bindRouter></app-route>
          <app-route path="*" redirect="/exercises"></app-route>
        </app-router>
      </div>
    </core-scaffold>
  </template>
  <script>
    Polymer({
      ready: function() {
        this.pages = [
          {
            name: 'Exercises',
            hash: 'exercises'
          }
        ];
      },
      onStateChangeAppRouter: function(event) {
        // redirect to the login page if not signed in
        if (!this.session.userId && event.detail.path !== '/login') {
          event.preventDefault();
          this.querySelector('::shadow app-router').go('/login');
        } else if (this.session.userId) {
          if (this.session.userRoles.indexOf('tutor') === -1 &&
              /\/exercises\/[0-9a-z]+\/edit/.test(event.detail.path)) {
            event.preventDefault();
            console.log('not authorised', event);
            this.querySelector('::shadow app-router').go('/forbidden', {replace: true});
          }
        }
      },
      onBeforeDataBindingLoginRoute: function(event) {
        event.detail.model.session = this.session;
      }
    });
  </script>
</polymer-element>
