<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import"
      href="../bower_components/paper-input/paper-autogrow-textarea.html">
<link rel="import"
      href="../bower_components/paper-input/paper-input-decorator.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">

<polymer-element name="je-app">
  <template>
    <paper-input-decorator label="Your solution Javascript code" floatingLabel>
      <paper-autogrow-textarea>
        <textarea value="{{code}}"></textarea>
      </paper-autogrow-textarea>
    </paper-input-decorator>

    <paper-button raised on-click="{{onSubmitClick}}">
      Submit your solution
    </paper-button>

    <core-ajax id="syntaxRequest" url="/rest/format" method="post"
               handleAs="json" body='{"code": "{{encoded}}"}'
               contentType="application/json"
               on-core-response="{{onSyntaxResponse}}"></core-ajax>

    <h1>Feedback</h1>
    <template repeat="{{item in feedback}}">
      <h2>{{item.name}}</h2>
      <div>
        <span>line: {{item.line}}</span>
        <span>column: {{item.column}}</span>
      </div>
      <p>{{item.description}}</p>
    </template>
  </template>
  <script>
    Polymer({
      publish: {
        code: '',
        encoded: '',
        feedback: ''
      },
      onSubmitClick: function() {
        console.log('Submit clicked');

        this.encoded = utf8_to_b64(this.code);
        console.log('Sending encoded code', typeof this.encoded, this.encoded);

        var decoded = b64_to_utf8(this.encoded);
        console.log('Decoded would be', typeof decoded, decoded);

        console.log('request', this.$.syntaxRequest.go());
      },
      onSyntaxResponse: function(response) {
        console.log('response', response);
        this.feedback = response.detail.response;
      }
    });

    /**
     * Source: https://developer.mozilla.org/en-US/docs/Web/API/WindowBase64.btoa
     */
    function utf8_to_b64(str) {
      return window.btoa(unescape(encodeURIComponent(str)));
    }
    function b64_to_utf8(str) {
      return decodeURIComponent(escape(window.atob(str)));
    }
  </script>
</polymer-element>